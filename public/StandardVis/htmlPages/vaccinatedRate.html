<!DOCTYPE html>
<html>

<head>
    <title>Vaccination Rates of Covid'19</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <style>
        body {
            min-height: calc(100vh - 16px);
            background-image: linear-gradient(0deg, #D8B5FF, #1EAE98);
        }

        .items {
            width: 25px;
            height: 25px;
        }

        .flex-container {
            display: flex;
            position: absolute;
            bottom: 0;
            right: 0;
            flex-direction: column;
            align-items: flex-end;
            margin: 10px;
        }

        .label h5 {
            margin: 0px;
            font-size: 0.8rem !important;
        }

        .layers {
            background-color: rgba(248, 248, 248, 0.408);
            backdrop-filter: blur(10px);
        }

        .searchbar {
            position: absolute;
            top: 30px;
            left: 60px;
            width: 200px;
            z-index: 1;
        }
    </style>
</head>

<body>
    <div class="container-fluid my-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="searchbar">
                            <select id="districtSelector" class="form-control" multiple></select>
                        </div>
                        <div id="map" style="width: 100%; height: 600px;">
                        </div>
                    </div>
                    <div class="flex-container">
                        <div>
                            <table>
                                <tr>
                                    <td class="items" id="legend-item1" style="background-color: #f3f3f3"></td>
                                    <td class="items" id="legend-item2" style="background-color: #c2f0ce"></td>
                                    <td class="items" id="legend-item3" style="background-color: #8ae1ae"></td>
                                </tr>
                            </table>
                            <div class="label">
                                <h5 class="text-center">Low <i class="fa-solid fa-arrow-right"></i> High</h5>
                                <h5>Vaccination Rate</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/maps.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.1/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="../utils.js"></script>
    <script>
        var vaccination = [];
        let selectedDist = [];

        async function apiCall() {
            const result = await axios.get("../simulationData.json");
            let geojson = await axios.get("../germany.geojson");
            const simulationData = [];

            // Iterate through germany.geojson districts
            for (let district of geojson.data.features) {
                const RS = district.properties.RS;
                const matchedDistrict = result.data.find((district) => district.RS == RS);
                simulationData.push(matchedDistrict);
            }

            for (let district of simulationData) {
                vaccination.push(district["vaccinationRate"])
            }

            const maxVaccination = Math.max(...vaccination);
            const rangeV = new ReMap(0, maxVaccination, 0, 1);

            drawMap(simulationData, rangeV);
        }

        function drawMap(data, rangeV) {
            map = am4core.create("map", am4maps.MapChart);
            map.geodataSource.url = "../germany.geojson";
            map.projection = new am4maps.projections.Mercator();

            polygonSeries = map.series.push(new am4maps.MapPolygonSeries());
            polygonSeries.useGeodata = true;

            map.geodataSource.events.on("parseended", () => {
                polygonSeries.data = data;
                polygonSeries.dataFields.RS = "RS";
                polygonSeries.dataFields.vaccinationRate = "vaccinationRate";
            });

            var polygonTemplate = polygonSeries.mapPolygons.template;

            polygonTemplate.adapter.add("fill", (fill, target) => {
                if (target.dataItem != undefined) {
                    var remappedV = rangeV.find(target.dataItem.vaccinationRate);

                    if (remappedV <= 0.33) {
                        //console.log("I am in grey zone")
                        polygonTemplate.fill = am4core.color("#f3f3f3");
                    }
                    else if (remappedV <= 0.66) {
                        //console.log("i am greater than 0.66")
                        polygonTemplate.fill = am4core.color("#c2f0ce");
                    }
                    else {
                        polygonTemplate.fill = am4core.color("#8ae1ae");
                    }
                    return polygonTemplate.fill
                }
                return fill
            })
            polygonTemplate.adapter.add("stroke", (stroke, target) => {
                if (selectedDist.includes(target.dataItem.RS)) {
                    return am4core.color("#ED1C24");
                }
                else {
                    return stroke;
                }
            })

            polygonTemplate.adapter.add("strokeWidth", (strokeWidth, target) => {
                if (selectedDist.includes(target.dataItem.RS)) {
                    return 3.5;
                }
                else {
                    return strokeWidth;
                }
            })
            polygonTemplate.strokeWidth = 1;
            polygonTemplate.tooltipText = "{GEN}";
            polygonSeries.tooltip.autoTextColor = false;
            polygonSeries.tooltip.label.fill = am4core.color("#000000");

            map.zoomControl = new am4maps.ZoomControl();
            map.zoomControl.align = "left";
            map.zoomControl.valign = "top";

            var homeButton = map.chartContainer.createChild(am4core.Button);
            homeButton.label.html = '<i class="fa-solid fa-location-crosshairs"></i>';
            homeButton.padding(5, 5, 5, 5);
            homeButton.width = 30;
            homeButton.align = "right";
            homeButton.marginRight = 15;
            homeButton.events.on("hit", function () {
                map.goHome();
            });
        }

        // District Selector
        async function initSelector() {
            const response = await axios.get('../district.json');
            const districtData = response.data;
            const districts = [];

            for (let district of districtData) {
                districts.push({ id: district.RS, text: district.GEN });
            }

            $("#districtSelector").select2({
                data: districts,
                placeholder: "Search Districts",
                maximumSelectionLength: 3
            });

            $("#districtSelector").on("change", () => {
                const selections = $('#districtSelector').select2("data");
                selectedDist = selections.map((district) => district.id);
                map.dispose();
                apiCall();
            });
        }

        initSelector();
        apiCall();
    </script>

</body>

</html>